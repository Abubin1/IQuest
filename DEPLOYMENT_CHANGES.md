# Инструкции по развертыванию изменений

## Изменения в проекте

### 1. Обновление экрана мероприятий
- **Файл**: `app/src/main/java/com/proj/quest/ui/main/EventsFragment.java`
- **Изменения**: 
  - Добавлена логика отображения ближайшего мероприятия пользователя в начале списка
  - Добавлена фильтрация мероприятий в течение недели (сегодня + 7 дней)
  - Сортировка мероприятий по дате

### 2. Обновление адаптера мероприятий
- **Файл**: `app/src/main/java/com/proj/quest/ui/adapters/EventAdapter.java`
- **Изменения**:
  - Добавлено специальное оформление для ближайшего мероприятия пользователя
  - Добавлена логика определения ближайшего мероприятия
  - Визуальное выделение ближайшего мероприятия (синий фон, звездочка)

### 3. Обновление модели пользователя
- **Файл**: `app/src/main/java/com/proj/quest/models/User.java`
- **Изменения**:
  - Добавлено поле `teamId` для отслеживания команды пользователя

### 4. Обновление layout
- **Файл**: `app/src/main/res/layout/item_event.xml`
- **Изменения**:
  - Добавлен `CardView` с id для стилизации
  - Добавлен `TextView` для отображения статуса "ближайшее мероприятие"

### 5. Обновление серверной части
- **Файл**: `Server/server.js`
- **Изменения**:
  - Обновлен эндпоинт `/api/profile` для возврата `teamId`
  - Добавлена проверка существующей команды при приглашении пользователя
  - Добавлена проверка существующей команды при принятии приглашения
  - Обновлен эндпоинт `/api/my-team` для возврата `teamId` участников

### 6. SQL скрипт для базы данных
- **Файл**: `Server/update_users_team_id.sql`
- **Назначение**: Добавление поля `teamId` в таблицу пользователей

### 7. Исправление обработки ошибок
- **Файл**: `app/src/main/java/com/proj/quest/Group/GroupActivity.java`
- **Изменения**:
  - Добавлена корректная обработка ошибок 400 от сервера при приглашении пользователей
  - Добавлена обработка ошибок при принятии/отклонении приглашений
  - Заменены Toast сообщения на диалоговые окна для лучшего UX

- **Файл**: `app/src/main/java/com/proj/quest/ui/main/EventDetailsActivity.java`
- **Изменения**:
  - Добавлена корректная обработка ошибок при регистрации команды на мероприятие
  - Заменены Toast сообщения на диалоговые окна для ошибок

### 8. Новый фрагмент для отображения приглашений в группу
- **Файл**: `app/src/main/java/com/proj/quest/ui/main/GroupsFragment.java`
- **Назначение**: Новый фрагмент для отображения приглашений в группу во вкладке "Группа"
- **Функции**:
  - Проверка наличия команды у пользователя
  - Отображение списка приглашений в группу
  - Возможность принять/отклонить приглашения
  - Кнопка создания новой группы при отсутствии приглашений

- **Файл**: `app/src/main/res/layout/fragment_groups.xml`
- **Назначение**: Layout для нового фрагмента групп

### 9. Обновление навигации
- **Файл**: `app/src/main/java/com/proj/quest/ui/main/MainActivity.java`
- **Изменения**:
  - Обновлена навигация для использования GroupsFragment вместо прямого перехода к GroupActivity

- **Файлы**: `GroupActivity.java`, `CreateGroupActivity.java`, `ProfileActivity.java`, `LeaderboardActivity.java`, `RiddleActivity.java`, `TeamsActivity.java`
- **Изменения**:
  - Обновлена навигация во всех активностях для перехода к GroupsFragment

## Инструкции по развертыванию

### 1. Обновление базы данных
```bash
# Подключитесь к PostgreSQL и выполните скрипт
psql -U postgres -d IQuest -f Server/update_users_team_id.sql
```

### 2. Перезапуск сервера
```bash
# Остановите текущий сервер (Ctrl+C)
# Запустите сервер заново
cd Server
npm start
```

### 3. Сборка Android приложения
```bash
# В корневой папке проекта
cd app
./gradlew assembleDebug
```

## Новые функции

### 1. Отображение ближайшего мероприятия
- Ближайшее мероприятие пользователя отображается в начале списка
- Визуально выделяется синим фоном и звездочкой
- Показывается текст "⭐ Ваше ближайшее мероприятие"

### 2. Фильтрация мероприятий по неделе
- Отображаются только мероприятия в течение недели (сегодня + 7 дней)
- Мероприятия сортируются по дате проведения

### 3. Проверка команды при приглашении
- Пользователь не может быть приглашен в команду, если уже состоит в другой
- При попытке приглашения выводится сообщение с названием текущей команды
- При попытке принять приглашение также проверяется существующая команда

### 4. Автоматическое обновление teamId
- Поле `teamId` автоматически обновляется при добавлении/удалении пользователей из команд
- Пользователь может состоять только в одной команде одновременно

### 5. Улучшенная обработка ошибок
- Все ошибки от сервера теперь отображаются в диалоговых окнах
- Пользователь видит точное сообщение об ошибке от сервера
- Улучшен UX при работе с приглашениями и регистрацией на мероприятия

### 6. Новый экран групп с приглашениями
- Во вкладке "Группа" теперь отображаются приглашения в группу
- Если у пользователя нет команды, показываются приглашения
- Если приглашений нет, предлагается создать группу
- Если у пользователя уже есть команда, происходит переход в GroupActivity
- Возможность принять/отклонить приглашения прямо из списка

## Тестирование

### 1. Проверка отображения мероприятий
- Убедитесь, что ближайшее мероприятие отображается в начале списка
- Проверьте, что мероприятия в течение недели отображаются корректно
- Убедитесь, что мероприятия старше недели не отображаются

### 2. Проверка приглашений
- Попробуйте пригласить пользователя, который уже состоит в команде
- Убедитесь, что выводится корректное сообщение об ошибке в диалоговом окне
- Проверьте, что пользователь не может принять приглашение, будучи в другой команде

### 3. Проверка регистрации на мероприятия
- Попробуйте зарегистрировать команду на мероприятие с ошибками
- Убедитесь, что ошибки отображаются в диалоговых окнах
- Проверьте, что сетевые ошибки обрабатываются корректно

### 4. Проверка teamId
- Убедитесь, что поле `teamId` корректно обновляется при изменении состава команды
- Проверьте, что при удалении команды `teamId` сбрасывается в NULL

### 5. Проверка нового экрана групп
- Проверьте отображение приглашений во вкладке "Группа"
- Убедитесь, что при отсутствии приглашений показывается кнопка "Создать группу"
- Проверьте, что при наличии команды происходит переход в GroupActivity
- Убедитесь, что приглашения можно принять/отклонить

## Исправленные проблемы

### 1. Обработка ошибок при приглашении
- **Проблема**: При попытке пригласить пользователя, который уже состоит в команде, показывалось "Приглашение отправлено", хотя сервер возвращал ошибку 400
- **Решение**: Добавлена корректная обработка ошибок от сервера с отображением точного сообщения об ошибке

### 2. Обработка ошибок при регистрации
- **Проблема**: Ошибки при регистрации команды на мероприятие отображались как Toast с кодом ошибки
- **Решение**: Добавлена обработка JSON ответа от сервера с отображением понятного сообщения об ошибке

### 3. UX при ошибках
- **Проблема**: Все ошибки отображались как Toast сообщения, которые быстро исчезали
- **Решение**: Заменены на диалоговые окна с кнопкой "OK" для лучшего восприятия

### 4. Отображение приглашений в группу
- **Проблема**: Во вкладке "Группа" не отображались приглашения в группу, только возможность создать группу
- **Решение**: Создан новый GroupsFragment, который отображает приглашения и позволяет их принимать/отклонять 